# ğŸ”„ Extractor Agent Flow - Hybrid NLP + Gemini

## ğŸ“‹ Overview
**ExtractorAgent** sá»­ dá»¥ng hybrid approach káº¿t há»£p **NLP preprocessing** vÃ  **Gemini LLM** Ä‘á»ƒ trÃ­ch xuáº¥t TTPs (Tactics, Techniques, Procedures) tá»« CTI reports.

---

## ğŸš€ Main Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    START: agent.start()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. INITIALIZATION PHASE                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚  âœ“ Initialize NLP components                                â”‚
â”‚    - NLPPipeline()                                          â”‚
â”‚    - EntityExtractor()                                      â”‚
â”‚    - ATTACKMapper()                                         â”‚
â”‚    - ConfidenceScorer()                                     â”‚
â”‚                                                             â”‚
â”‚  âœ“ Initialize Gemini LLM Client                            â”‚
â”‚    - Load API key from config/env                          â”‚
â”‚    - Create GeminiClient or MockGeminiClient               â”‚
â”‚    - Test connection                                        â”‚
â”‚                                                             â”‚
â”‚  âœ“ Load Configuration                                      â”‚
â”‚    - Model: gemini-2.0-flash-lite                          â”‚
â”‚    - Max tokens: 1000                                       â”‚
â”‚    - Temperature: 0.3                                       â”‚
â”‚    - Min confidence threshold: 0.5                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            INPUT: agent.execute(input_data)                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚  normalized_reports: [                                      â”‚
â”‚    {                                                        â”‚
â”‚      report_id: "...",                                      â”‚
â”‚      title: "...",                                          â”‚
â”‚      description: "...",                                    â”‚
â”‚      threat_actors: [...],                                  â”‚
â”‚      malware_families: [...],                               â”‚
â”‚      indicators: [...]                                      â”‚
â”‚    }                                                        â”‚
â”‚  ]                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. VALIDATION PHASE                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚  âœ“ Validate input data structure                           â”‚
â”‚  âœ“ Check required fields (report_id, description)          â”‚
â”‚  âœ“ Verify agent is not paused                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Loop for each report           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. HYBRID EXTRACTION PHASE                                 â”‚
â”‚     _extract_from_report_hybrid()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                     â”‚
        â–¼                                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.1 CACHE CHECK     â”‚                          â”‚ Cache HIT?           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                          â”‚ âœ“ Return cached      â”‚
â”‚ â€¢ Check report_id   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€YESâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   result             â”‚
â”‚ â€¢ Cache enabled?    â”‚                          â”‚ âœ“ Update stats       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ NO
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.2 NLP PROCESSING PHASE                                    â”‚
â”‚     _nlp_processing()                                       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  A. Text Processing (NLPPipeline)                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚     â”‚ â€¢ Clean text                         â”‚               â”‚
â”‚     â”‚ â€¢ Split sentences                    â”‚               â”‚
â”‚     â”‚ â€¢ Extract technical terms            â”‚               â”‚
â”‚     â”‚ â€¢ Extract file paths                 â”‚               â”‚
â”‚     â”‚ â€¢ Extract registry keys              â”‚               â”‚
â”‚     â”‚ â€¢ Extract commands                   â”‚               â”‚
â”‚     â”‚ â€¢ Extract network artifacts          â”‚               â”‚
â”‚     â”‚   (IPs, domains, URLs)               â”‚               â”‚
â”‚     â”‚ â€¢ Extract security keywords          â”‚               â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  B. Entity Extraction (EntityExtractor)                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚     â”‚ â€¢ Malware families                   â”‚               â”‚
â”‚     â”‚ â€¢ Tools (PowerShell, Mimikatz...)    â”‚               â”‚
â”‚     â”‚ â€¢ Threat actors (APT28, Lazarus...)  â”‚               â”‚
â”‚     â”‚ â€¢ Attack techniques (T1566.001...)   â”‚               â”‚
â”‚     â”‚ â€¢ IOCs:                              â”‚               â”‚
â”‚     â”‚   - IP addresses                     â”‚               â”‚
â”‚     â”‚   - Domains                          â”‚               â”‚
â”‚     â”‚   - File hashes (MD5, SHA1, SHA256)  â”‚               â”‚
â”‚     â”‚   - Email addresses                  â”‚               â”‚
â”‚     â”‚   - File names                       â”‚               â”‚
â”‚     â”‚   - Ports                            â”‚               â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  C. TTP Indicator Detection                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚     â”‚ Map keywords to tactics:             â”‚               â”‚
â”‚     â”‚ â€¢ Initial Access (phishing...)       â”‚               â”‚
â”‚     â”‚ â€¢ Execution (PowerShell, cmd...)     â”‚               â”‚
â”‚     â”‚ â€¢ Persistence (registry...)          â”‚               â”‚
â”‚     â”‚ â€¢ Credential Access (mimikatz...)    â”‚               â”‚
â”‚     â”‚ â€¢ Defense Evasion (obfuscate...)     â”‚               â”‚
â”‚     â”‚ â€¢ Discovery (enumerate...)           â”‚               â”‚
â”‚     â”‚ â€¢ Lateral Movement (RDP, SMB...)     â”‚               â”‚
â”‚     â”‚ â€¢ Collection (archive...)            â”‚               â”‚
â”‚     â”‚ â€¢ Exfiltration (upload...)           â”‚               â”‚
â”‚     â”‚ â€¢ Command & Control (C2, beacon...)  â”‚               â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  â±ï¸ Timing: ~50-200ms                                       â”‚
â”‚  ğŸ“Š Stats: nlp_processing_time_ms, nlp_entities_extracted  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.3 CREATE NLP-BASED TTPs                                   â”‚
â”‚     _create_ttps_from_nlp_indicators()                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  â€¢ Convert TTP indicators â†’ TTP objects                     â”‚
â”‚  â€¢ Format:                                                  â”‚
â”‚    {                                                        â”‚
â”‚      technique_name: "PowerShell",                          â”‚
â”‚      tactic: "Execution",                                   â”‚
â”‚      description: "Detected via NLP",                       â”‚
â”‚      indicators: [],                                        â”‚
â”‚      tools: [...],                                          â”‚
â”‚      extraction_method: "nlp"                               â”‚
â”‚    }                                                        â”‚
â”‚                                                             â”‚
â”‚  ğŸ“Š Result: nlp_ttps []                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.4 LLM EXTRACTION PHASE (Gemini)                           â”‚
â”‚     _extract_ttps_with_llm_enhanced()                       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  A. Build Enhanced Prompt                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚     â”‚ Include:                             â”‚               â”‚
â”‚     â”‚ â€¢ Report title                       â”‚               â”‚
â”‚     â”‚ â€¢ Threat actors                      â”‚               â”‚
â”‚     â”‚ â€¢ Malware families                   â”‚               â”‚
â”‚     â”‚ â€¢ NLP findings summary:              â”‚               â”‚
â”‚     â”‚   - Entities found                   â”‚               â”‚
â”‚     â”‚   - Commands detected                â”‚               â”‚
â”‚     â”‚   - File paths                       â”‚               â”‚
â”‚     â”‚   - Registry keys                    â”‚               â”‚
â”‚     â”‚   - TTP indicators                   â”‚               â”‚
â”‚     â”‚ â€¢ IOC summary                        â”‚               â”‚
â”‚     â”‚ â€¢ Technical indicators from NLP      â”‚               â”‚
â”‚     â”‚ â€¢ Full report description            â”‚               â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  B. Call Gemini API                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚     â”‚ model.generate_content(prompt)       â”‚               â”‚
â”‚     â”‚ â€¢ Model: gemini-2.0-flash-lite       â”‚               â”‚
â”‚     â”‚ â€¢ Max tokens: 1000                   â”‚               â”‚
â”‚     â”‚ â€¢ Temperature: 0.3                   â”‚               â”‚
â”‚     â”‚ â€¢ Async execution via executor       â”‚               â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  C. Parse JSON Response                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚     â”‚ â€¢ Remove markdown (```json...)       â”‚               â”‚
â”‚     â”‚ â€¢ Parse JSON array                   â”‚               â”‚
â”‚     â”‚ â€¢ Validate TTP structure             â”‚               â”‚
â”‚     â”‚ â€¢ Set defaults for missing fields    â”‚               â”‚
â”‚     â”‚ â€¢ Mark extraction_method: "gemini"   â”‚               â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  â±ï¸ Timing: ~500-2000ms (API call)                         â”‚
â”‚  ğŸ“Š Stats: llm_processing_time_ms, gemini_api_calls        â”‚
â”‚  ğŸ“Š Result: llm_ttps []                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.5 COMBINE TTPs                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  all_ttps = nlp_ttps + llm_ttps                            â”‚
â”‚                                                             â”‚
â”‚  Example:                                                   â”‚
â”‚  â€¢ NLP TTPs: 2-5 techniques (pattern-based)                â”‚
â”‚  â€¢ LLM TTPs: 3-8 techniques (context-aware)                â”‚
â”‚  â€¢ Total: 5-13 TTPs                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.6 ATT&CK MAPPING PHASE                                    â”‚
â”‚     _map_ttps_to_attack()                                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  For each TTP:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ â€¢ Match technique_name to ATT&CK DB  â”‚                  â”‚
â”‚  â”‚ â€¢ Fuzzy matching                     â”‚                  â”‚
â”‚  â”‚ â€¢ Add ATT&CK metadata:               â”‚                  â”‚
â”‚  â”‚   - attack_id (T1566.001)            â”‚                  â”‚
â”‚  â”‚   - attack_name                      â”‚                  â”‚
â”‚  â”‚   - tactic                           â”‚                  â”‚
â”‚  â”‚   - subtechnique flag                â”‚                  â”‚
â”‚  â”‚   - mapping_source                   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                             â”‚
â”‚  ğŸ“Š Result: mapped_ttps []                                  â”‚
â”‚  ğŸ“Š Stats: total_attack_mappings, mapping_errors           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.7 ENTITY ENRICHMENT                                       â”‚
â”‚     _enrich_ttps_with_entities()                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  For each TTP, add:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ â€¢ related_entities:                  â”‚                  â”‚
â”‚  â”‚   - malware: [Emotet, Mimikatz]      â”‚                  â”‚
â”‚  â”‚   - tools: [PowerShell, cmd]         â”‚                  â”‚
â”‚  â”‚   - threat_actors: [APT28]           â”‚                  â”‚
â”‚  â”‚                                      â”‚                  â”‚
â”‚  â”‚ â€¢ correlated_iocs:                   â”‚                  â”‚
â”‚  â”‚   - network: [IPs, domains]          â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                             â”‚
â”‚  ğŸ“Š Result: enriched_ttps []                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.8 CONFIDENCE SCORING                                      â”‚
â”‚     _score_ttps()                                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  Multi-factor confidence calculation:                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ 1. Base Score (from LLM or default)  â”‚                  â”‚
â”‚  â”‚    - LLM confidence: 0.1-1.0         â”‚                  â”‚
â”‚  â”‚    - Default NLP: 0.5                â”‚                  â”‚
â”‚  â”‚                                      â”‚                  â”‚
â”‚  â”‚ 2. Extraction Method Bonus           â”‚                  â”‚
â”‚  â”‚    - gemini_llm: +0.10               â”‚                  â”‚
â”‚  â”‚    - nlp: +0.05                      â”‚                  â”‚
â”‚  â”‚                                      â”‚                  â”‚
â”‚  â”‚ 3. ATT&CK Mapping Bonus              â”‚                  â”‚
â”‚  â”‚    - Mapped: +0.10                   â”‚                  â”‚
â”‚  â”‚    - Unmapped: +0.00                 â”‚                  â”‚
â”‚  â”‚                                      â”‚                  â”‚
â”‚  â”‚ 4. Entity Correlation Bonus          â”‚                  â”‚
â”‚  â”‚    - Has malware: +0.05              â”‚                  â”‚
â”‚  â”‚                                      â”‚                  â”‚
â”‚  â”‚ Final = min(base + bonuses, 1.0)     â”‚                  â”‚
â”‚  â”‚                                      â”‚                  â”‚
â”‚  â”‚ 5. Confidence Level                  â”‚                  â”‚
â”‚  â”‚    - >= 0.8: "high"                  â”‚                  â”‚
â”‚  â”‚    - >= 0.6: "medium"                â”‚                  â”‚
â”‚  â”‚    - >= 0.4: "low"                   â”‚                  â”‚
â”‚  â”‚    - < 0.4: "very_low"               â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                             â”‚
â”‚  ğŸ“Š Result: scored_ttps []                                  â”‚
â”‚  ğŸ“Š Stats: avg_confidence_score, high_confidence_ttps      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.9 FILTERING                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  Filter TTPs by confidence threshold:                       â”‚
â”‚  â€¢ Keep only: confidence_score >= 0.5                       â”‚
â”‚  â€¢ Sort by confidence (high â†’ low)                          â”‚
â”‚                                                             â”‚
â”‚  ğŸ“Š Result: filtered_ttps []                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.10 FORMAT FOR HANDOFF                                     â”‚
â”‚      _format_ttp_for_handoff()                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  Transform to RuleGen-compatible format:                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ {                                    â”‚                  â”‚
â”‚  â”‚   ttp_id: uuid4(),                   â”‚                  â”‚
â”‚  â”‚   report_id: "...",                  â”‚                  â”‚
â”‚  â”‚   technique_name: "...",             â”‚                  â”‚
â”‚  â”‚   attack_id: "T1566.001",            â”‚                  â”‚
â”‚  â”‚   tactic: "Initial Access",          â”‚                  â”‚
â”‚  â”‚   description: "...",                â”‚                  â”‚
â”‚  â”‚   confidence_score: 0.85,            â”‚                  â”‚
â”‚  â”‚   confidence_level: "high",          â”‚                  â”‚
â”‚  â”‚   confidence_breakdown: {...},       â”‚                  â”‚
â”‚  â”‚   evidence_text: "...",              â”‚                  â”‚
â”‚  â”‚   indicators_supporting: [...],      â”‚                  â”‚
â”‚  â”‚   context: {                         â”‚                  â”‚
â”‚  â”‚     threat_actor: "APT28",           â”‚                  â”‚
â”‚  â”‚     malware_used: ["Emotet"],        â”‚                  â”‚
â”‚  â”‚     campaign: "..."                  â”‚                  â”‚
â”‚  â”‚   },                                 â”‚                  â”‚
â”‚  â”‚   extraction_method: "hybrid",       â”‚                  â”‚
â”‚  â”‚   mapped_by: "gemini_nlp_hybrid",    â”‚                  â”‚
â”‚  â”‚   extracted_timestamp: "...",        â”‚                  â”‚
â”‚  â”‚   tools: [...],                      â”‚                  â”‚
â”‚  â”‚   related_entities: {...},           â”‚                  â”‚
â”‚  â”‚   correlated_iocs: {...},            â”‚                  â”‚
â”‚  â”‚   subtechnique: true/false,          â”‚                  â”‚
â”‚  â”‚   mapping_source: "..."              â”‚                  â”‚
â”‚  â”‚ }                                    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                             â”‚
â”‚  ğŸ“Š Result: formatted_ttps []                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.11 CACHE RESULT                                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”‚
â”‚  if enable_caching:                                         â”‚
â”‚    cache[report_id] = extraction_result                     â”‚
â”‚                                                             â”‚
â”‚  ğŸ“Š Stats: cache_hits, cache_misses                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  End of report loop             â”‚
        â”‚  Repeat for next report         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. AGGREGATION & STATISTICS                                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  Calculate aggregate metrics:                               â”‚
â”‚  â€¢ total_ttps_extracted                                     â”‚
â”‚  â€¢ avg_ttps_per_report                                      â”‚
â”‚  â€¢ high_confidence_ttps                                     â”‚
â”‚  â€¢ extraction_errors                                        â”‚
â”‚  â€¢ processing_time_ms                                       â”‚
â”‚  â€¢ gemini_api_calls                                         â”‚
â”‚  â€¢ nlp_processing_time_ms                                   â”‚
â”‚  â€¢ llm_processing_time_ms                                   â”‚
â”‚  â€¢ avg_confidence_score                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            OUTPUT: Extraction Results                       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚  {                                                          â”‚
â”‚    agent_id: "...",                                         â”‚
â”‚    status: "success",                                       â”‚
â”‚    timestamp: "...",                                        â”‚
â”‚    extraction_summary: {                                    â”‚
â”‚      reports_processed: 1,                                  â”‚
â”‚      total_ttps_extracted: 8,                               â”‚
â”‚      avg_ttps_per_report: 8.0,                              â”‚
â”‚      high_confidence_ttps: 5,                               â”‚
â”‚      extraction_errors: 0,                                  â”‚
â”‚      processing_time_ms: 1234,                              â”‚
â”‚      gemini_api_calls: 1,                                   â”‚
â”‚      nlp_processing_time_ms: 120,                           â”‚
â”‚      llm_processing_time_ms: 980                            â”‚
â”‚    },                                                       â”‚
â”‚    extraction_results: [                                    â”‚
â”‚      {                                                      â”‚
â”‚        report_id: "...",                                    â”‚
â”‚        source_report: {...},                                â”‚
â”‚        extracted_ttps: [...],  // Formatted for RuleGen     â”‚
â”‚        nlp_analysis: {                                      â”‚
â”‚          entities: {...},                                   â”‚
â”‚          ttp_indicators: {...},                             â”‚
â”‚          processing_stats: {...}                            â”‚
â”‚        },                                                   â”‚
â”‚        metadata: {...}                                      â”‚
â”‚      }                                                      â”‚
â”‚    ],                                                       â”‚
â”‚    statistics: {...}                                        â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Flow Summary

```
CTI Report
    â†“
NLP Processing
    â”œâ”€ Text Analysis (50ms)
    â”œâ”€ Entity Extraction (30ms)
    â””â”€ TTP Indicators (20ms)
    â†“
Combined Input
    â”œâ”€ NLP TTPs (2-5)
    â””â”€ Enhanced Prompt
        â†“
    Gemini API (500-2000ms)
        â†“
    LLM TTPs (3-8)
    â†“
Merge TTPs (5-13)
    â†“
ATT&CK Mapping
    â†“
Entity Enrichment
    â†“
Confidence Scoring
    â†“
Filtering (â‰¥0.5)
    â†“
Format for Handoff
    â†“
Output (3-10 high-quality TTPs)
```

---

## â±ï¸ Performance Metrics

| Phase | Time (ms) | Notes |
|-------|-----------|-------|
| NLP Processing | 50-200 | Fast, local processing |
| LLM Extraction | 500-2000 | API call, main bottleneck |
| ATT&CK Mapping | 10-50 | Local dictionary lookup |
| Scoring & Filtering | 5-20 | Calculation only |
| **Total** | **600-2500** | ~1-2 seconds per report |

---

## ğŸ“ˆ Statistics Tracked

```python
stats = {
    "total_reports_processed": 0,
    "total_ttps_extracted": 0,
    "nlp_entities_extracted": 0,
    "nlp_ttp_indicators_found": 0,
    "gemini_ttps_extracted": 0,
    "extraction_errors": 0,
    "gemini_api_calls": 0,
    "avg_confidence_score": 0.0,
    "high_confidence_ttps": 0,
    "processing_time_ms": 0,
    "nlp_processing_time_ms": 0,
    "llm_processing_time_ms": 0,
    "cache_hits": 0,
    "cache_misses": 0
}
```

---

## ğŸ¯ Key Features

1. **Hybrid Approach**: Combines NLP (fast, pattern-based) + LLM (context-aware)
2. **Multi-factor Confidence**: Base + method + mapping + entity correlation
3. **Caching**: Avoids re-processing same reports
4. **Entity Enrichment**: Links TTPs with malware, tools, threat actors
5. **ATT&CK Mapping**: Automatic mapping to MITRE framework
6. **Error Handling**: Graceful degradation if LLM fails
7. **Performance Tracking**: Detailed timing and statistics

---

## ğŸ”§ Configuration Points

| Setting | Default | Description |
|---------|---------|-------------|
| `use_nlp_preprocessing` | `true` | Enable NLP analysis |
| `use_mock` | `false` | Use mock LLM (no API) |
| `model` | `gemini-2.0-flash-lite` | Gemini model |
| `max_tokens` | `1000` | Max response tokens |
| `temperature` | `0.3` | LLM creativity |
| `min_confidence` | `0.5` | Filter threshold |
| `enable_caching` | `true` | Cache results |
| `batch_size` | `5` | Reports per batch |

---

## ğŸš¦ Error Handling

```
Error Scenarios:
â”œâ”€ API Key Missing â†’ Use Mock LLM
â”œâ”€ Gemini API Failure â†’ Return NLP-only TTPs
â”œâ”€ Invalid JSON Response â†’ Empty LLM TTPs, keep NLP TTPs
â”œâ”€ ATT&CK Mapping Fail â†’ Mark as UNMAPPED
â”œâ”€ Empty Report â†’ Skip, log error
â””â”€ Validation Error â†’ Skip, increment error count
```

---

## ğŸ“¤ Output to RuleGen

Formatted TTPs are ready for RuleGen agent:
- Standard structure with all required fields
- Rich context (threat actor, malware, campaign)
- Confidence scores and breakdowns
- Supporting indicators and evidence
- ATT&CK IDs for rule generation